<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify AI Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .message-enter {
            animation: slideUp 0.3s ease-out;
        }
        .gradient-bg {
            background: linear-gradient(-45deg, #000000, #0a0a0a, #1a1a1a, #000000);
            background-size: 400% 400%;
            animation: gradient-shift 20s ease infinite;
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .music-mode-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
        }
        .btn-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-hover:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="app" class="flex flex-col h-screen">
        <!-- Minimalist Header -->
        <div class="glass border-b border-white/5 p-4">
            <div class="max-w-3xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-black" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-white font-semibold text-sm">Spotify AI</h1>
                        <p class="text-gray-500 text-xs" id="user-name">Loading...</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button id="music-mode-toggle" class="glass text-gray-400 hover:text-white px-4 py-2 rounded-full text-sm font-medium transition-all btn-hover">
                        <span id="mode-icon">ðŸŽµ</span>
                        <span id="mode-text">Music Only</span>
                    </button>
                    <a href="/logout" class="glass text-gray-400 hover:text-white p-2 rounded-full transition-all btn-hover">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages" class="flex-1 overflow-y-auto p-6 max-w-3xl w-full mx-auto">
            <div id="messages-container" class="space-y-6"></div>
        </div>

        <!-- Music Mode Indicator -->
        <div id="music-mode-banner" class="hidden">
            <div class="max-w-3xl mx-auto px-6 py-3">
                <div class="glass rounded-full px-4 py-2 flex items-center gap-2 text-purple-300 text-sm">
                    <span class="animate-pulse">âœ¨</span>
                    <span>Music Only Mode Active</span>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="glass border-t border-white/5 p-6">
            <div class="max-w-3xl mx-auto">
                <div class="flex gap-3 items-end">
                    <div class="flex-1">
                        <input
                            type="text"
                            id="message-input"
                            placeholder="Ask about your music..."
                            class="w-full bg-white/5 text-white placeholder-gray-500 rounded-2xl px-6 py-4 focus:outline-none focus:ring-2 focus:ring-green-500/50 border border-white/10 transition-all"
                        />
                    </div>
                    <button
                        id="send-button"
                        class="bg-gradient-to-r from-green-400 to-green-600 hover:from-green-500 hover:to-green-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-black rounded-2xl p-4 transition-all transform hover:scale-105 disabled:scale-100 btn-hover"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </div>
                
                <div class="mt-4 flex gap-2 flex-wrap justify-center">
                    <button class="quick-action glass text-xs text-gray-400 hover:text-white px-4 py-2 rounded-full transition-all btn-hover" data-message="What have I been listening to lately?">
                        Recent Plays
                    </button>
                    <button class="quick-action glass text-xs text-gray-400 hover:text-white px-4 py-2 rounded-full transition-all btn-hover" data-message="Recommend me something new">
                        Recommendations
                    </button>
                    <button class="quick-action glass text-xs text-gray-400 hover:text-white px-4 py-2 rounded-full transition-all btn-hover" data-message="What's my music vibe?">
                        My Vibe
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let musicOnlyMode = false;
        let conversationHistory = [];
        let isLoading = false;

        async function init() {
            try {
                const response = await fetch('/api/user');
                const user = await response.json();
                document.getElementById('user-name').textContent = user.name;
                
                addMessage('assistant', "Hey! I've synced with your Spotify. What do you want to know about your music?");
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        document.getElementById('music-mode-toggle').addEventListener('click', function() {
            musicOnlyMode = !musicOnlyMode;
            const banner = document.getElementById('music-mode-banner');
            const input = document.getElementById('message-input');
            const modeIcon = document.getElementById('mode-icon');
            const modeText = document.getElementById('mode-text');
            
            if (musicOnlyMode) {
                this.className = 'music-mode-active text-white px-4 py-2 rounded-full text-sm font-medium transition-all btn-hover';
                modeIcon.textContent = 'âœ¨';
                modeText.textContent = 'Music Only ON';
                banner.classList.remove('hidden');
                input.placeholder = "Ask me anything...";
            } else {
                this.className = 'glass text-gray-400 hover:text-white px-4 py-2 rounded-full text-sm font-medium transition-all btn-hover';
                modeIcon.textContent = 'ðŸŽµ';
                modeText.textContent = 'Music Only';
                banner.classList.add('hidden');
                input.placeholder = "Ask about your music...";
            }
        });

        function addMessage(role, content) {
            const container = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} message-enter`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-[75%] rounded-2xl px-5 py-3 ${
                role === 'user'
                    ? 'bg-gradient-to-r from-green-400 to-green-600 text-black font-medium'
                    : 'glass text-white border border-white/10'
            }`;
            bubble.style.wordWrap = 'break-word';
            bubble.textContent = content;
            
            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
            
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function showLoading() {
            const container = document.getElementById('messages-container');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex justify-start message-enter';
            loadingDiv.innerHTML = `
                <div class="glass text-white border border-white/10 rounded-2xl px-5 py-3 flex items-center gap-2">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                    </div>
                </div>
            `;
            container.appendChild(loadingDiv);
        }

        function hideLoading() {
            const loading = document.getElementById('loading-indicator');
            if (loading) loading.remove();
        }

        async function sendMessage(message) {
            if (!message.trim() || isLoading) return;
            
            isLoading = true;
            document.getElementById('send-button').disabled = true;
            document.getElementById('message-input').value = '';
            
            addMessage('user', message);
            conversationHistory.push({ role: 'user', content: message });
            showLoading();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        music_only_mode: musicOnlyMode,
                        history: conversationHistory
                    })
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.response) {
                    addMessage('assistant', data.response);
                    conversationHistory.push({ role: 'assistant', content: data.response });
                } else if (data.error) {
                    addMessage('assistant', `Error: ${data.error}`);
                } else {
                    addMessage('assistant', 'Something went wrong. Try again?');
                }
            } catch (error) {
                hideLoading();
                console.error('Fetch error:', error);
                addMessage('assistant', 'Connection error. Try again?');
            } finally {
                isLoading = false;
                document.getElementById('send-button').disabled = false;
            }
        }

        document.getElementById('send-button').addEventListener('click', function() {
            const input = document.getElementById('message-input');
            sendMessage(input.value);
        });

        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(this.value);
            }
        });

        document.querySelectorAll('.quick-action').forEach(button => {
            button.addEventListener('click', function() {
                sendMessage(this.dataset.message);
            });
        });

        init();
    </script>
</body>
</html>
